@using CemSys3.DTOs.Paginacion
@model PaginacionDTO

@{
    // Aseguramos que el diccionario de parámetros no sea nulo
    var parametrosBase = Model.Parametros ?? new Dictionary<string, string>();
}

<nav aria-label="Paginador" class="mt-4">
    <ul class="pagination justify-content-center mb-2">

        @* --- Botón Anterior --- *@
        @if (Model.PaginaActual > 1)
        {
            <li class="page-item">
                @{
                    var prevParams = new Dictionary<string, string>(parametrosBase);
                    prevParams["pagina"] = (Model.PaginaActual - 1).ToString();
                    prevParams["porPagina"] = Model.RegistrosPorPagina.ToString();
                }
                <a class="page-link" asp-action="@Model.Accion" asp-controller="@Model.Controlador" asp-all-route-data="prevParams">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        }

        @* --- Lógica de Números --- *@
        @{
            int paginaInicio = Math.Max(1, Model.PaginaActual - 2);
            int paginaFin = Math.Min(Model.TotalPaginas, Model.PaginaActual + 2);
        }

        @* Primera página *@
        @if (paginaInicio > 1)
        {
            <li class="page-item">
                @{
                    var firstParams = new Dictionary<string, string>(parametrosBase);
                    firstParams["pagina"] = "1";
                    firstParams["porPagina"] = Model.RegistrosPorPagina.ToString();
                }
                <a class="page-link" asp-action="@Model.Accion" asp-controller="@Model.Controlador" asp-all-route-data="firstParams">1</a>
            </li>
            @if (paginaInicio > 2)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
        }

        @* Páginas del rango *@
        @for (int i = paginaInicio; i <= paginaFin; i++)
        {
            <li class="page-item @(i == Model.PaginaActual ? "active" : "")">
                @if (i == Model.PaginaActual)
                {
                    <span class="page-link">@i</span>
                }
                else
                {
                    var pageParams = new Dictionary<string, string>(parametrosBase);
                    pageParams["pagina"] = i.ToString();
                    pageParams["porPagina"] = Model.RegistrosPorPagina.ToString();

                    <a class="page-link" asp-action="@Model.Accion" asp-controller="@Model.Controlador" asp-all-route-data="pageParams">@i</a>
                }
            </li>
        }

        @* Última página *@
        @if (paginaFin < Model.TotalPaginas)
        {
            @if (paginaFin < Model.TotalPaginas - 1)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
            <li class="page-item">
                @{
                    var lastParams = new Dictionary<string, string>(parametrosBase);
                    lastParams["pagina"] = Model.TotalPaginas.ToString();
                    lastParams["porPagina"] = Model.RegistrosPorPagina.ToString();
                }
                <a class="page-link" asp-action="@Model.Accion" asp-controller="@Model.Controlador" asp-all-route-data="lastParams">@Model.TotalPaginas</a>
            </li>
        }

        @* --- Botón Siguiente --- *@
        @if (Model.PaginaActual < Model.TotalPaginas)
        {
            <li class="page-item">
                @{
                    var nextParams = new Dictionary<string, string>(parametrosBase);
                    nextParams["pagina"] = (Model.PaginaActual + 1).ToString();
                    nextParams["porPagina"] = Model.RegistrosPorPagina.ToString();
                }
                <a class="page-link" asp-action="@Model.Accion" asp-controller="@Model.Controlador" asp-all-route-data="nextParams">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        }
    </ul>

    @* --- Información y Selector --- *@
    <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
        <small class="text-muted">
            Página <strong>@Model.PaginaActual</strong> de @Model.TotalPaginas
            (@Model.TotalRegistros registros)
        </small>

        <div class="d-flex align-items-center">
            <label class="me-2 small text-muted">Mostrar:</label>
            <select id="selectRegistros" class="form-select form-select-sm mb-2" style="width: 80px;">
                <!option value="10" @(Model.RegistrosPorPagina == 10 ? "selected" : "")>10</!option>
                <!option value="50" @(Model.RegistrosPorPagina == 50 ? "selected" : "")>50</!option>
                <!option value="100" @(Model.RegistrosPorPagina == 100 ? "selected" : "")>100</!option>
            </select>
        </div>
    </div>
</nav>

<script>
    document.getElementById("selectRegistros")?.addEventListener("change", function () {
        const porPagina = this.value;
        const urlParams = new URLSearchParams(window.location.search);

        // Mantener el filtro actual si existe
        const filtro = urlParams.get('filtro') || '';

        // Redirigir usando 'porPagina' (nombre exacto del parámetro en tu Controller)
        const url = `@Url.Action(Model.Accion, Model.Controlador)?pagina=1&porPagina=${porPagina}&filtro=${filtro}`;
        window.location.href = url;
    });
</script>